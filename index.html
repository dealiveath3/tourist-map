<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>47éƒ½é“åºœçœŒãƒ»æ··é›‘äºˆæ¸¬ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const apiKey = 'e786ea10f3cfe410f0dcb6576dbeacd0';

    const cities = [
      { name: 'æœ­å¹Œå¸‚', lat: 43.06417, lon: 141.34694 },
      { name: 'é’æ£®å¸‚', lat: 40.82444, lon: 140.74 },
      { name: 'ç››å²¡å¸‚', lat: 39.70361, lon: 141.1525 },
      { name: 'ä»™å°å¸‚', lat: 38.26889, lon: 140.87194 },
      { name: 'ç§‹ç”°å¸‚', lat: 39.71861, lon: 140.1025 },
      { name: 'å±±å½¢å¸‚', lat: 38.24056, lon: 140.36333 },
      { name: 'ç¦å³¶å¸‚', lat: 37.75, lon: 140.46778 },
      { name: 'æ°´æˆ¸å¸‚', lat: 36.34139, lon: 140.44667 },
      { name: 'å®‡éƒ½å®®å¸‚', lat: 36.56583, lon: 139.88361 },
      { name: 'å‰æ©‹å¸‚', lat: 36.39111, lon: 139.06083 },
      { name: 'ã•ã„ãŸã¾å¸‚', lat: 35.85694, lon: 139.64889 },
      { name: 'åƒè‘‰å¸‚', lat: 35.60472, lon: 140.12333 },
      { name: 'æ–°å®¿åŒº', lat: 35.68944, lon: 139.69167 },
      { name: 'æ¨ªæµœå¸‚', lat: 35.44778, lon: 139.6425 },
      { name: 'æ–°æ½Ÿå¸‚', lat: 37.90222, lon: 139.02361 },
      { name: 'å¯Œå±±å¸‚', lat: 36.69528, lon: 137.21139 },
      { name: 'é‡‘æ²¢å¸‚', lat: 36.59444, lon: 136.62556 },
      { name: 'ç¦äº•å¸‚', lat: 36.06528, lon: 136.22194 },
      { name: 'ç”²åºœå¸‚', lat: 35.66389, lon: 138.56833 },
      { name: 'é•·é‡å¸‚', lat: 36.65139, lon: 138.18111 },
      { name: 'å²é˜œå¸‚', lat: 35.39111, lon: 136.72222 },
      { name: 'é™å²¡å¸‚', lat: 34.97694, lon: 138.38306 },
      { name: 'åå¤å±‹å¸‚', lat: 35.18028, lon: 136.90667 },
      { name: 'æ´¥å¸‚', lat: 34.73028, lon: 136.50861 },
      { name: 'å¤§æ´¥å¸‚', lat: 35.00444, lon: 135.86833 },
      { name: 'äº¬éƒ½å¸‚', lat: 35.02139, lon: 135.75556 },
      { name: 'å¤§é˜ªå¸‚', lat: 34.68639, lon: 135.52 },
      { name: 'ç¥æˆ¸å¸‚', lat: 34.69139, lon: 135.18306 },
      { name: 'å¥ˆè‰¯å¸‚', lat: 34.68528, lon: 135.83278 },
      { name: 'å’Œæ­Œå±±å¸‚', lat: 34.22611, lon: 135.1675 },
      { name: 'é³¥å–å¸‚', lat: 35.50361, lon: 134.23833 },
      { name: 'æ¾æ±Ÿå¸‚', lat: 35.47222, lon: 133.05056 },
      { name: 'å²¡å±±å¸‚', lat: 34.66167, lon: 133.935 },
      { name: 'åºƒå³¶å¸‚', lat: 34.39639, lon: 132.45944 },
      { name: 'å±±å£å¸‚', lat: 34.18583, lon: 131.47139 },
      { name: 'å¾³å³¶å¸‚', lat: 34.06583, lon: 134.55944 },
      { name: 'é«˜æ¾å¸‚', lat: 34.34028, lon: 134.04333 },
      { name: 'æ¾å±±å¸‚', lat: 33.84167, lon: 132.76611 },
      { name: 'é«˜çŸ¥å¸‚', lat: 33.55972, lon: 133.53111 },
      { name: 'ç¦å²¡å¸‚', lat: 33.60639, lon: 130.41806 },
      { name: 'ä½è³€å¸‚', lat: 33.24944, lon: 130.29889 },
      { name: 'é•·å´å¸‚', lat: 32.74472, lon: 129.87361 },
      { name: 'ç†Šæœ¬å¸‚', lat: 32.78972, lon: 130.74167 },
      { name: 'å¤§åˆ†å¸‚', lat: 33.23806, lon: 131.6125 },
      { name: 'å®®å´å¸‚', lat: 31.91111, lon: 131.42389 },
      { name: 'é¹¿å…å³¶å¸‚', lat: 31.56028, lon: 130.55806 },
      { name: 'é‚£è¦‡å¸‚', lat: 26.2125, lon: 127.68111 }
    ];

    const map = L.map('map').setView([36.2048, 138.2529], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    function getDayName() {
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      return days[new Date().getDay()];
    }

    function getCongestionLevel(day, weather) {
      const weekend = ['Saturday', 'Sunday'];
      const isWeekend = weekend.includes(day);
      const isSunny = weather === 'Clear' || weather === 'Clouds';

      if (isWeekend && isSunny) return { level: 'high', color: 'red' };
      if (isWeekend && !isSunny) return { level: 'medium', color: 'orange' };
      if (!isWeekend && isSunny) return { level: 'medium', color: 'yellow' };
      return { level: 'low', color: 'blue' };
    }

    async function fetchWeather(city) {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${city.lat}&lon=${city.lon}&appid=${apiKey}&units=metric`;
      const response = await fetch(url);
      const data = await response.json();
      return data.weather[0].main;
    }

    async function displayCities() {
  const day = getDayName();
  for (const city of cities) {
    const weather = await fetchWeather(city);
    const { level, color } = getCongestionLevel(day, weather);

    const marker = L.circleMarker([city.lat, city.lon], {
      radius: 10,
      color: color,
      fillColor: color,
      fillOpacity: 0.8
    }).addTo(map);

    marker.bindPopup(`<strong>${city.name}</strong><br>å¤©æ°—: ${weather}<br>æ›œæ—¥: ${day}<br>æ··é›‘ãƒ¬ãƒ™ãƒ«: <strong>${level}</strong>`);
  }
}

async function displayCities() {
  const day = getDayName();
  for (const city of cities) {
    try {
      const weather = await fetchWeather(city);
      const { level, color } = getCongestionLevel(day, weather);

      const marker = L.circleMarker([city.lat, city.lon], {
        radius: 10,
        color: color,
        fillColor: color,
        fillOpacity: 0.8
      }).addTo(map);

      const popupContent = createPopup(city.name);
      marker.bindPopup(popupContent);

      await new Promise(resolve => setTimeout(resolve, 300));
    } catch (err) {
      console.error(`å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—: ${city.name}`, err);
    }
  }
}

// --- ç´ æã‚«ãƒ†ã‚´ãƒªä¸€è¦§ ---
const materials = ["æ¸©æ³‰", "è‡ªç„¶", "æ­´å²", "ä¼èª¬", "ã‚°ãƒ«ãƒ¡", "ç¥­ã‚Š", "å‹•ç‰©", "ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ"];

// ãƒ©ãƒ³ãƒ€ãƒ ç´ æå–å¾—
function getRandomMaterial() {
  return materials[Math.floor(Math.random() * materials.length)];
}

// ç´ æä¿å­˜
function saveMaterial(city, material) {
  const today = new Date().toISOString().split('T')[0];
  const key = `materials_${today}`;
  let data = JSON.parse(localStorage.getItem(key)) || [];
  data.push({ city, material });
  localStorage.setItem(key, JSON.stringify(data));
  displayCollectedMaterials();
}

// ç´ æä¸€è¦§è¡¨ç¤º
function displayCollectedMaterials() {
  const today = new Date().toISOString().split('T')[0];
  const key = `materials_${today}`;
  let data = JSON.parse(localStorage.getItem(key)) || [];
  const container = document.getElementById('material-log');
  container.innerHTML = "<h3>æœ¬æ—¥ã‚²ãƒƒãƒˆã—ãŸç´ æ</h3>";
  if (data.length === 0) {
    container.innerHTML += "<p>ã¾ã ç´ æã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    return;
  }
  const list = document.createElement('ul');
  data.forEach(entry => {
    const item = document.createElement('li');
    item.textContent = `ğŸ§­ ${entry.city} â†’ ã€Œ${entry.material}ã€`;
    list.appendChild(item);
  });
  container.appendChild(list);
}

// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”Ÿæˆ
function createPopup(cityName) {
  const material = getRandomMaterial();
  const popup = L.DomUtil.create('div');
  popup.innerHTML = `<strong>${cityName}</strong><br>`;
  const button = L.DomUtil.create('button', '', popup);
  button.textContent = "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ç´ æGETï¼";
  button.onclick = () => {
    alert(`ã€Œ${material}ã€ã‚’ã‚²ãƒƒãƒˆï¼`);
    saveMaterial(cityName, material);
  };
  return popup;
}
  </script>
</body>
</html>
